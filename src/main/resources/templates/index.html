<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TodoZ-main</title>
        <link rel="stylesheet" href="/new.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
    </head>
<script th:inline="javascript">

    var messages = [[${messages}]];

    function urlB64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }

        return outputArray;
    }

    const publicKeyBase64 = 'BKVvKfX0nn7uwsAgdEpBW_XEF1rOcMKRaQEheDzqcBusYqXO8Xdd6coDJrO364yuiWIXU-8xYEQ4PpzFLRsl-9c';

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/js/service-worker.js')
            .then(function(registration) {
                console.log('Service Worker registered successfully:', registration);
                return registration;
            })
            .catch((error) => {
                console.error('Error registering Service Worker:', error);
            })
            .then(function(registration) {
                const applicationServerKey = urlB64ToUint8Array(publicKeyBase64);

                return registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey,
                });
            })
            .then(function(subscription) {
                console.log('Push Subscription successful:', subscription);

                fetch('/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(subscription),
                });
            })
            .catch(function(error) {
                console.error('Error setting up Service Worker:', error);
            });
    }

</script>
<body>
<section class="app home">
    <header>
        <a th:href="@{/longTerm}"> Long term </a>
        <h2 th:text="|Week ${currentWeek.getWeekNumber()}|"></h2>
<!--        <a th:href="@{/weekReview}"> Week review </a>-->
        <a th:href="@{/pussyMeter}"> Pussy meter </a>
    </header>

    <main>
        <div class="task" th:each="task : ${currentWeek.getTasks()}" th:object="${task}" th:data-priority="*{priority}" th:data-id="*{id}">
            <p th:text="*{description}"></p>
            <span class="due" th:text="*{getRemainingDays()}" th:data-duedate="*{dueDateDate}"></span>
            <form th:action="@{/checked/{id}(id=${task.getId()})}" th:method="POST">
                <input type="hidden" th:name="done" th:value="${!task.isDone()}"/>
                <button class="img" th:type="submit">
                    <img th:if="*{done}" src="/img/vector_img_checkedbox.png" alt="mark as not done"/>
                    <img th:unless="*{done}" src="/img/vector_img_checkbox.png" alt="mark as done"/>
               </button>
            </form>
        </div>
    </main>

    <footer>
        <form method="post" th:action="@{/add}">
            <button type="submit" name="priority" value="4" class="hidden"></button>

            <div class="stars">
                <button type="submit" name="priority" value="4">üî•</button>
                <button type="submit" name="priority" value="3">‚≠ê</button>
                <button type="submit" name="priority" value="2">üê¢</button>
                <button type="submit" name="priority" value="1">üßä</button>
            </div>

            <label class="dateTime hidden">
                <input type="date" name="maybeDueDate" id="date">
            </label>

            <label class="addTask">
                <input type="text" placeholder="new task" name="description" id="add" required>
                <img onclick="toggleDueDate()" src="/img/Clock_Yellow.png" alt="due date">
            </label>
        </form>
    </footer>

    <script>
        function toggleDueDate(state) {
            const CLASS = "hidden";
            const classList = document.querySelector(".dateTime").classList;

            if (state === undefined) {
                classList.toggle(CLASS);
                document.querySelector("#date").value = "";
            } else if (state === true) {
                classList.remove(CLASS);
                document.querySelector("#date").focus();
            } else {
                classList.add(CLASS);
                document.querySelector("#date").value = "";
                document.querySelector("#add").focus();
            }
        }

        document.querySelector("main").addEventListener("click", function (event) {
            if (event.target.tagName !== "P") {
                return;
            }
            let task = event.target.closest(".task");
            if (!task) {
                return;
            }

            edit(task);
        });

        function edit(task) {
            const main = document.querySelector("main");
            registerCancel(main);

            const description = task.querySelector("p").innerText;
            const dueDate = task.querySelector(".due").dataset.duedate;
            const priority = task.dataset.priority;

            const form = document.querySelector("footer form");

            form.action = "/tasks/" + task.dataset.id;
            form.querySelector("input[name='description']").value = description;
            form.querySelector("input[name='maybeDueDate']").value = dueDate;
            form.querySelector("button[name='priority']").value = priority;

            if (dueDate) {
                toggleDueDate(true);
            } else {
                toggleDueDate(false);
            }

            function registerCancel(el) {
                el.classList.add("fade");

                el.addEventListener("click", function () {
                    cancelEdit();
                }, {once: true});

                window.onkeydown = function (event) {
                    if (event.key === "Escape") {
                        cancelEdit();
                    }
                }

                function cancelEdit() {
                    location.reload();
                }
            }
        }
    </script>

</section>
</body>
</html>