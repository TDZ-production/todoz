<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TodoZ-main</title>
        <link rel="stylesheet" href="/new.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
    </head>
<script th:inline="javascript">

    var messages = [[${messages}]];

    function rotateArray(arr){
        var nextItem = arr.shift();
        arr.push(nextItem);
        return nextItem
    }

    function showNotification() {

        if (Notification.permission === 'granted') {
            const nextMessage = rotateArray(messages);
            new Notification(nextMessage.title,  { body: nextMessage.description });
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(function (permission) {
                if (permission === 'granted') {
                    showNotification();
                }
            });
        }
    }
    setInterval(showNotification,  10000 );

</script>
<body>
<section class="app home">
    <header>
        <a th:href="@{/longTerm}"> Long term </a>
        <h2 th:text="|Week ${currentWeek.getWeekNumber()}|"></h2>
<!--        <a th:href="@{/weekReview}"> Week review </a>-->
        <a th:href="@{/pussyMeter}"> Pussy meter </a>
    </header>

    <main>
        <div class="task" th:each="task : ${currentWeek.getTasks()}" th:object="${task}" th:data-priority="*{priority}" th:data-id="*{id}">
            <p th:text="*{description}"></p>
            <span class="due" th:text="*{getRemainingDays()}" th:data-duedate="*{dueDateDate}"></span>
            <form th:action="@{/checked/{id}(id=${task.getId()})}" th:method="POST">
                <input type="hidden" th:name="done" th:value="${!task.isDone()}"/>
                <button class="img" th:type="submit">
                    <img th:if="*{done}" src="/img/vector_img_checkedbox.png" alt="mark as not done"/>
                    <img th:unless="*{done}" src="/img/vector_img_checkbox.png" alt="mark as done"/>
               </button>
            </form>
        </div>
    </main>

    <footer>
        <form method="post" th:action="@{/add}">
            <button type="submit" name="priority" value="4" class="hidden">default</button>

            <div class="stars">
                <button type="submit" name="priority" value="4">üî•</button>
                <button type="submit" name="priority" value="3">‚≠ê</button>
                <button type="submit" name="priority" value="2">üê¢</button>
                <button type="submit" name="priority" value="1">üßä</button>
            </div>

            <label class="dateTime hidden">
                <input type="date" name="maybeDueDate" id="date">
            </label>

            <label class="addTask">
                <input type="text" placeholder="new task" name="description" id="add" required>
                <img onclick="toggleDueDate()" src="/img/Clock_Yellow.png" alt="due date">
            </label>
        </form>
    </footer>

    <script>
        function toggleDueDate(state) {
            const CLASS = "hidden";
            const classList = document.querySelector(".dateTime").classList;

            if (state === undefined) {
                classList.toggle(CLASS);
            } else if (state === true) {
                classList.remove(CLASS);
                document.querySelector("#date").focus();
            } else {
                classList.add(CLASS);
                document.querySelector("#date").value = "";
                document.querySelector("#add").focus();
            }
        }

        document.querySelector("main").addEventListener("click", function (event) {
            if (event.target.tagName === "MAIN") {
                return;
            }
            let task = event.target.closest(".task");
            if (!task) {
                return;
            }

            edit(task);
        });

        function edit(task) {
            let description = task.querySelector("p").innerText;
            let dueDate = task.querySelector(".due").dataset.duedate;
            let priority = task.dataset.priority;

            let form = document.querySelector("footer form");
            form.action = "/tasks/" + task.dataset.id;
            form.querySelector("input[name='description']").value = description;
            if (dueDate) {
                toggleDueDate(true);
            } else {
                toggleDueDate(false);
            }
            form.querySelector("input[name='maybeDueDate']").value = dueDate;
            form.querySelector("button[name='priority']").value = priority;

        }
    </script>

</section>
</body>
</html>